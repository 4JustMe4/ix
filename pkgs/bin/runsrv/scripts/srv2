#!/bin/sh

exec 1>>"err"
exec 2>&1

. /etc/env

set -xue

SRV_DIR=/var/run/${1}
STD_DIR=${SRV_DIR}/std

shift

mkdir -p ${STD_DIR}

cd ${STD_DIR}

# TODO(pg): check it
export TMPDIR=${PWD}

PP=$$
P=/sys/fs/cgroup/srv/${PP}

mkdir -p ${P}

echo ${PP} > ${P}/cgroup.procs

cleanup() (
    echo 1 > ${P}/cgroup.kill
)

trap cleanup TERM INT EXIT

flock lock logged ./ setcwd ${SRV_DIR} ${@} &

wait
