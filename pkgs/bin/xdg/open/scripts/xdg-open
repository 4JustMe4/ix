#!/usr/bin/env sh

on_browser() {
    exec epiphany "${1}"
}

on_pdf() {
    for c in xpdf qpdf mupdf zathura evince; do
        if command -v ${c}; then
            exec ${c} "${1}"
        fi
    done

    on_browser "${1}"
}

on_image() {
    for c in pqiv qimgv imv swayimg; do
        if command -v ${c}; then
            exec ${c} "${1}"
        fi
    done

    on_browser "${1}"
}

on_video() {
    for c in mpv mplayer; do
        if command -v ${c}; then
            exec ${c} "${1}"
        fi
    done

    on_browser "${1}"
}

on_archive() {
    for c in xarchiver; do
        if command -v ${c}; then
            exec ${c} "${1}"
        fi
    done

    exit 1
}

url_decode() {
    # TODO(pg) - rewrite in C++
    python3 -c 'import urllib.parse as up; import sys; print(up.unquote(sys.argv[1])[7:])' "${1}"
}

url="${1}"

case "${url}" in
    file://*)
        url=$(url_decode "${url}")
    ;;
esac

if test -f "${url}"; then
    mt=$(file -b --mime-type "${url}")

    case "${mt}" in
        application/pdf)
            on_pdf "${url}"
        ;;

        image/*)
            on_image "${url}"
        ;;

        video/*)
            on_video "${url}"
        ;;

        application/gzip)
            on_archive "${url}"
        ;;

        application/x-bzip2)
            on_archive "${url}"
        ;;

        application/x-lzip)
            on_archive "${url}"
        ;;

        application/x-rar)
            on_archive "${url}"
        ;;

        application/x-xz)
            on_archive "${url}"
        ;;

        application/zip)
            on_archive "${url}"
        ;;
    esac
fi

if test -d "${url}"; then
    if command -v pcmanfm; then
        exec pcmanfm "${url}"
    fi
fi

on_browser "${1}"
