#!/usr/bin/env sh

echo "${@}" >> /home/pg/xdglog

on_browser() {
    exec epiphany "${1}"
}

on_pdf() {
    if command -v mupdf; then
        exec mupdf "${1}"
    fi

    if command -v evince; then
        exec evince "${1}"
    fi

    if command -v qpdf; then
        exec qpdf "${1}"
    fi

    if command -v xpdf; then
        exec xpdf "${1}"
    fi

    on_browser "${1}"
}

on_image() {
    if command -v pqiv; then
        exec pqiv "${1}"
    fi

    if command -v qimgv; then
        exec qimgv "${1}"
    fi

    if command -v imv; then
        exec imv "${1}"
    fi

    if command -v swayimg; then
        exec swayimg "${1}"
    fi

    on_browser "${1}"
}

url_decode() {
    # TODO(pg) - rewrite in C++
    python3 -c 'import urllib.parse as up; import sys; print(up.unquote(sys.argv[1])[7:])' "${1}"
}

url="${1}"

case "${url}" in
    file://*)
        url=$(url_decode "${url}")
    ;;
esac

if test -f "${url}"; then
    mt=$(file -b --mime-type "${url}")

    case "${mt}" in
        application/pdf)
            on_pdf "${url}"
        ;;

        image/*)
            on_image "${url}"
        ;;
    esac
fi

if test -d "${url}"; then
    if command -v pcmanfm; then
        exec pcmanfm "${url}"
    fi
fi

on_browser "${1}"
